workflows:
  ios-build:
    name: iOS Build (React Native)
    max_build_duration: 120
    instance_type: mac_mini_m1  # or mac_pro

    environment:
      vars:
        XCODE_WORKSPACE: "ios/YourApp.xcworkspace"
        XCODE_SCHEME: "YourApp"

    scripts:
      - name: Set up Node.js and dependencies
        script: |
          brew install node
          npm install -g yarn
          yarn install

      - name: Install Pods
        script: |
          sudo gem install cocoapods # Update hoặc cài đặt CocoaPods
          cd ios
          pod repo update # Update repo Podspecs nếu cần
          rm -rf Podfile.lock Pods # Xóa Podfile.lock và Pods
          pod install

      - name: Set up Code Signing
        script: |
          security create-keychain -p "" build.keychain
          security import $APPLE_CERTIFICATE_PATH -k build.keychain -P $APPLE_CERTIFICATE_PASSWORD -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $APPLE_PROVISIONING_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build iOS App
        script: |
          xcodebuild clean archive \
          -workspace $XCODE_WORKSPACE \
          -scheme $XCODE_SCHEME \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $CM_BUILD_DIR/YourApp.xcarchive \
          CODE_SIGN_STYLE=Manual \
          PROVISIONING_PROFILE_SPECIFIER="" \
          CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA
        script: |
          xcodebuild -exportArchive \
          -archivePath $CM_BUILD_DIR/YourApp.xcarchive \
          -exportPath $CM_BUILD_DIR/build/ \
          -exportOptionsPlist ios/exportOptions.plist

    artifacts:
      - build/**/*.ipa
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Logs/Test/*.xcresult

    publishing:
      email:
        recipients:
          - your-email@example.com
